# 1. 銀行内顧客支援システムの開発

## 1.1. 目次

- [1. 銀行内顧客支援システムの開発](#1-銀行内顧客支援システムの開発)
  - [1.1. 目次](#11-目次)
  - [1.2. プロジェクト概要](#12-プロジェクト概要)
  - [1.3. 期間／規模／役割](#13-期間規模役割)
  - [1.4. 実績](#14-実績)
  - [1.5. 実施内容1：オンプレミスサーバ上でのk8sクラスタを利用した環境構築](#15-実施内容1オンプレミスサーバ上でのk8sクラスタを利用した環境構築)
    - [1.5.1. 背景・課題・問題点](#151-背景課題問題点)
    - [1.5.2. 取り組み](#152-取り組み)
    - [1.5.3. 結果](#153-結果)
  - [1.6. 実施内容2：ソースコード管理](#16-実施内容2ソースコード管理)
    - [1.6.1. 背景・課題・問題点](#161-背景課題問題点)
    - [1.6.2. 取り組み](#162-取り組み)
    - [1.6.3. 結果](#163-結果)
  - [1.7. 実施内容3：プロジェクト管理およびリリース管理](#17-実施内容3プロジェクト管理およびリリース管理)
    - [1.7.1. 背景・課題・問題点](#171-背景課題問題点)
    - [1.7.2. 取り組み](#172-取り組み)
    - [1.7.3. 結果](#173-結果)
  - [1.8. その他アピールポイント](#18-その他アピールポイント)
    - [1.8.1. チャレンジ精神](#181-チャレンジ精神)
  - [1.9. 開発言語・使用技術](#19-開発言語使用技術)
    - [1.9.1. 開発言語](#191-開発言語)
    - [1.9.2. 使用技術](#192-使用技術)

## 1.2. プロジェクト概要

- Phase1：銀行内システムに分散されている情報を統合する統合DBシステムの開発
- Phase2：AI技術を活用したマッチング機能および経営課題抽出機能の開発
- 運用・保守：追加機能や不具合改修の定期リリース、AIモデルの定期更新

## 1.3. 期間／規模／役割

- 2019/06 - 現在／2 - 3名／メンバー
  - 2019/06 - 2020/09：Phase1
  - 2020/09 - 2021/06：Phase2
  - 2020/09 - 現在：保守・運用

## 1.4. 実績

- 外部設計書、運用マニュアル等のドキュメント作成
- オンプレミスサーバ上にKubernetes（以下、k8s）クラスタ構築
  - リリース回数／システム稼働率：60回以上／99.5%以上
- フロントエンドおよびバックエンドの設計・実装
- DB設計
- パフォーマンスチューニング
- モノレポ構成とkindを利用した開発環境の整備
- GitHub Projects機能などを利用したプロジェクト管理およびリリース管理の改善

---

以下、特筆すべき実施内容のみ記載。

## 1.5. 実施内容1：オンプレミスサーバ上でのk8sクラスタを利用した環境構築

### 1.5.1. 背景・課題・問題点

- 外部ネットワークに接続することができないため、オンプレミスのWindows Server上に動作環境をつくる必要があった。
- お客様は将来的なクラウド利用に前向きだった。
- オンプレミスサーバのハードウェア管理はハードウェアベンダーが担当。
- 社内でオンプレミスサーバ、特にWindows Serverでのシステム環境構築に関するノウハウがなかった。
- 当時、社内ではUbuntu（WSL含む）およびDockerを利用した開発が主流だった。
- Phase2で実現する内容や方法が具体的に決まっていなかった。
- Phase2以降もシステムを拡張していく可能性があった。

### 1.5.2. 取り組み

以下の考えのもと、システム基盤としてk8sクラスタ構築を採用した。

- 将来的に本システムをクラウド環境に移行するとなった場合、移行が容易。
- 社内エンジニアはLinux・Dockerを利用した開発に慣れているため抵抗感が少ない。
- 今後、オンプレミス上に環境を構築する際に技術転用できる。
- 柔軟に拡張・変更できる拡張性、リリースを容易に行うことができる可搬性が必要。
- オートスケーリング機能により、リソース割当てを柔軟に行うことができる。
- オートヒーリング機能により、障害によっては即座に現地に赴いて対応しなくても良くなる。
- 構築難易度が高いが、構築後の作業を考えると導入するメリットが大きい。

k8sクラスタ構築作業定型化にあたり、未決定事項や課題が多かった。
調査だけでなく、実際に触る方が分かることも多いと考え、以下のように技術調査とドキュメント作成を並行しながら実施した。

1. k8sを構築するにあたっての技術調査
   - ネットワーク設定、DNS設定、NFSの利用、必要メモリ、ロードバランシングなど
2. システム構成、ディレクトリ構成などの未決定事項や課題洗い出し
3. 社内検証サーバ上で環境仮構築
4. 仮構築後、改善点や追加課題について洗い出し
5. 解決事項や決定事項はドキュメントに記載
6. 1.~5.を繰り返し

最終的に、Hyper-V上にマスターノード用、ワーカーノード用、NFS用のUbuntu Server仮想マシンを作成し、k8sクラスタを構築した。
別の軽量OSにすることも検討したが、社内エンジニアの慣れているUbuntuを採用した。

### 1.5.3. 結果

- 新しいAPIサーバや新機能リリース時でも、容易にリリース作業を行うことができている。
- APIサーバの負荷が一時的に増加したことがあったが、水平オートスケーリング機能によりトラフィックの分散ができていた。
- APIサーバの負荷が一時的に増加したことにより、いくつかのPodでエラーが発生していたが、オートヒーリング機能によりPodの再起動ができ、被害を最小限に抑えることができた。
- 名前空間によって、リリース前の受け入れテスト環境を容易に構築することができた。

## 1.6. 実施内容2：ソースコード管理

### 1.6.1. 背景・課題・問題点

- 社内ではマルチレポ構成が主流だった。
- Webサーバ、アプリケーションサーバ、APIサーバなど複数のサーバにおいて開発や設定情報の管理を行う必要があった。
- 本プロジェクトでの開発物は、別プロジェクトに流用できる可能性が低かった。
- 本プロジェクトにアサインしているメンバーが少なかった。

### 1.6.2. 取り組み

以下の考えのもと、本プロジェクトでは、モノレポ構成によるソースコード管理を採用した。

- セルフマネージドk8sであるため、各サーバを組み合わせた動作検証を頻繁に行う必要がある。
- セルフマネージドk8sであるため、開発時にもできるだけk8sを使用したい。
- メンバーが少ないため、マルチレポ構成にするとリポジトリの切替えや参照容易性の低下など、デメリットが大きい。
- 流用可能性が低いこともあり、モノレポ構成にした場合のデメリットが少ない。

併せて、以下も実施した。

- kindによるローカルk8s環境構築
- k8sリソースのPersistentVolume、PersistentVolumeClaimを使ってローカルディレクトリをk8s Podにマウント
- メインに開発を行うアプリケーションサーバおよびAPIサーバのホットリロード化

### 1.6.3. 結果

- 横断的にソースコードを参照・変更することが容易になり、プロジェクトとして見通しが良くなった。
- ローカル開発時にもk8s環境を意識できた。
- skaffoldのようにdockerイメージの再ビルドを行わないため、変更内容を即座にk8s上で確認できた。

## 1.7. 実施内容3：プロジェクト管理およびリリース管理

### 1.7.1. 背景・課題・問題点

- お客様からの要望事項は、PMに電話やメール、口頭にて連絡される。
- 要望事項はエクセルファイルにて管理されていたため、以下の課題があった。
  - 共同編集しづらい。
  - 議論の結果を残しづらい。
  - ソースコードとの同時参照がしづらい。
  - 作業進捗が確認しづらい。
- 平均して毎月のように新機能追加や不具合改修リリースが行われる。

### 1.7.2. 取り組み

エクセルファイルによる管理から、GitHub Projects機能を利用したKanban方式へ変更した。
運用の概要は以下の通り。

- 要望事項には専用のラベルを付与してIssueを作成
- 要望事項に対する議論はIssue上で実施
- ToDo、InProgress、InReview、ClosedなどのKanbanカラムを活用してステータス管理
- Pull RequestにはIssueを紐づける

加えて、GitHubのMilestoneも併用した。

- リリース予定のIssueやPRをMilestoneに登録
- 該当バージョンのリリースノートにMilestoneのリンクを記載

### 1.7.3. 結果

- プロジェクト管理およびリリース管理にかかる工数が減った。
- 要望事項と開発のステータスが同時に参照できるようになった。
- 要望事項に対して議論がしやすり、以前よりメンバーから積極的に意見がでるようになった。
- リリース内容の管理が容易になった。

---

## 1.8. その他アピールポイント

### 1.8.1. チャレンジ精神

本プロジェクトは入社してはじめての案件であり、当時はインフラ構築やdockerやk8sについて未経験だった。
インフラ構築初学者にとって、技術選定からインフラ構築、リリースまではとても難易度が高く、最初はどうして良いか分からず不安だった。
しかし、技術の学習からはじめ、洗い出した課題をひとつずつクリアしていった。
最終的に、一人でセルフマネージドk8s構築をすることができた。

本プロジェクトを通して、困難な課題にも果敢に取り組む自信をつけることができた。

---

## 1.9. 開発言語・使用技術

### 1.9.1. 開発言語

| カテゴリ           | 開発言語                        |
| ------------------ | ------------------------------- |
| フロントエンド     | HTML, JavaScript                |
| バックエンド       | Python                          |
| 開発補助スクリプト | Batfile, Shell Script, Makefile |

### 1.9.2. 使用技術

量が多いため、前述した実施内容関連のみ記載。

| カテゴリ                   | 使用技術                                      | 使用目的                                                                                   |
| -------------------------- | --------------------------------------------- | ------------------------------------------------------------------------------------------ |
| OS                         | Windows Server 2019                           | 物理サーバのルートOS                                                                       |
| OS                         | Ubuntu 18.04 LTS Server                       | 仮想マシン（マスターノード、ワーカーノード、NFSサーバなど）                                |
| ハイパーバイザ             | Hyper-V                                       | 仮想マシンの管理                                                                           |
| aptパッケージ              | nfs-kernel-server                             | NFSサーバの構築                                                                            |
| aptパッケージ              | chrony                                        | サーバ構築環境上での代替NTPサーバ                                                          |
| aptパッケージ              | unbound                                       | サーバ構築環境上での代替DNSサーバ                                                          |
| k8s関連                    | kubeadm                                       | k8sクラスタの構築                                                                          |
| k8s関連                    | flannel                                       | オーバーレイ・ネットワークの構築                                                           |
| k8s関連                    | MetalLB                                       | L2ロードバランシング                                                                       |
| k8s関連                    | Helm, ChartMuseum                             | Prometheus、Grafanaなどのインストール                                                      |
| k8s関連                    | Argo Workflows                                | 日次や週次、月次で実行するパイプラインの管理・自動化                                       |
| k8s関連                    | Kustomize                                     | ローカル開発環境、検証環境、テスト環境、本番環境のk8sYAMLファイル管理の効率化              |
| k8s関連                    | kind                                          | ローカル開発環境の構築                                                                     |
| オブザーバビリティ         | Prometheus                                    | システムのリソースモニタリング                                                             |
| オブザーバビリティ         | Grafana Loki                                  | システムのロギング                                                                         |
| オブザーバビリティ         | Grafana                                       | リソースモニタリング結果およびログの確認                                                   |
| Webサーバ                  | NGINX                                         | アプリケーションサーバやAPIサーバへとリクエストを転送（リバースプロキシ）                  |
| DB関連                     | MySQL 8.x                                     | システムのデータ保持                                                                       |
| DB関連                     | Percona XtraBackup                            | MySQLコンテナのレプリケーション                                                            |
| DB関連                     | phpMyAdmin                                    | MySQLのデータ確認                                                                          |
| ライブラリ・フレームワーク | locust                                        | システム負荷テスト                                                                         |
| GitHub機能                 | Issues, Projects(Kanban), Milestone, Releases | 要望事項・改善事項と開発進捗の管理およびリリース管理                                       |
| Google Cloud               | Container Registry                            | システムで利用しているコンテナの管理                                                       |
| その他ツール               | LXDE                                          | デスクトップ接続可能な管理用Ubuntuコンテナ（※）の作成、GrafanaやphpMyAdminなど管理UIの利用 |
| その他ツール               | Slack                                         | チームメンバーとの情報共有                                                                 |
| その他ツール               | PlantUML                                      | シーケンス図やフローチャートなどの作図                                                     |
| その他ツール               | Rlogin                                        | Hyper-V上の各仮想マシンへのSSH接続                                                         |

※管理用Ubuntuコンテナが必要な理由：お客様環境のクライアントPCのブラウザがIE8であり、GrafanaやphpMyAdminなどのWebアプリケーションの表示ができないため
