# 1. パーソナライズレコメンドAPIの開発（Phase2）

## 1.1. 目次

- [1. パーソナライズレコメンドAPIの開発（Phase2）](#1-パーソナライズレコメンドapiの開発phase2)
  - [1.1. 目次](#11-目次)
  - [1.2. プロジェクト概要](#12-プロジェクト概要)
  - [1.3. 期間／規模／役割](#13-期間規模役割)
  - [1.4. 実績](#14-実績)
  - [1.5. 実施内容1：インターフェース仕様策定](#15-実施内容1インターフェース仕様策定)
    - [1.5.1. 背景・課題・問題点](#151-背景課題問題点)
    - [1.5.2. 取り組み](#152-取り組み)
    - [1.5.3. 結果](#153-結果)
  - [1.6. 実施内容2：プロジェクト全体のデータ連携処理の整理](#16-実施内容2プロジェクト全体のデータ連携処理の整理)
    - [1.6.1. 背景・課題・問題点](#161-背景課題問題点)
    - [1.6.2. 取り組み](#162-取り組み)
    - [1.6.3. 結果](#163-結果)
  - [1.7. 実施内容3：Neo4jデータ管理](#17-実施内容3neo4jデータ管理)
    - [1.7.1. 背景・課題・問題点](#171-背景課題問題点)
    - [1.7.2. 取り組み](#172-取り組み)
    - [1.7.3. 結果](#173-結果)
  - [1.8. 実施内容4：Neo4jへのデータ登録機能およびNeo4jからのデータ出力機能の再実装](#18-実施内容4neo4jへのデータ登録機能およびneo4jからのデータ出力機能の再実装)
    - [1.8.1. 背景・課題・問題点／取り組み／結果](#181-背景課題問題点取り組み結果)
  - [1.9. その他アピールポイント](#19-その他アピールポイント)
    - [1.9.1. キャッチアップ力](#191-キャッチアップ力)
    - [1.9.2. 行動力](#192-行動力)
  - [1.10. 開発言語・使用技術](#110-開発言語使用技術)

## 1.2. プロジェクト概要

SNSのデータに加えて購買情報や顧客属性情報などのビッグデータを解析することにより、個人を特定しない形でリアルタイムなトレンドに沿ったレコメンドを行うAPIの開発。

※Phase1：PoC・要件定義・基本設計／Phase2：開発・テスト・システム稼働

## 1.3. 期間／規模／役割

- 2021/12 - 2022/02／10名／メンバー

## 1.4. 実績

- データ連携インターフェース仕様書やNeo4j仕様書等のドキュメント作成
- Neo4jへのデータ登録機能12項目、Neo4jからのデータ出力機能4項目、API2項目の実装
  - 実装テスト数／テストカバレッジ：500以上／85%以上
- Neo4jの制約・インデックス管理
- メンバー作成Neo4jクエリのパフォーマンス改善

---

以下、特筆すべき実施内容のみ記載。

## 1.5. 実施内容1：インターフェース仕様策定

Neo4j入出力に関係する、データ連携のインターフェース仕様を策定した。
必須項目かどうか、データフォーマット、デフォルト値、特殊なデータ変換方法の明記などを行った。

### 1.5.1. 背景・課題・問題点

- 受領する連携データのフォーマットがPoC段階のもので、お客様と最終的な合意に至っていなかった。
- 前任者の退職が相次いだこともあり、ドキュメントが不十分もしくは存在しなかった。
- Neo4jのデータを取り扱うメンバーが、Neo4j内のデータ過不足を把握していなかった。

### 1.5.2. 取り組み

お客様との合意が必要な部分については、会社の信頼にも関わるため、早急に対応した。
このとき、まずは社内での調査・整理を徹底し、お客様の負担を減らすことを意識した。
具体的には以下のように進めた。

1. Neo4jのデータを取り扱うメンバーにヒアリング
   - 必要なデータは何か、使用目的は、どのタイミングで必要か、受領データの過不足など
2. 受領データのフォーマットを弊社希望前提で一度見直し、インターフェース仕様書案を作成
3. インターフェース仕様書案を基にお客様DB担当者と会議
4. お客様と合意がとれるまで 1.〜3.を繰り返し
5. お客様より受領データのサンプル受領、データ検証
6. 受領データに不備があればお客様に報告、再送依頼

### 1.5.3. 結果

- お客様に対する誠実な姿勢が評価され、その後の連携がしやすくなった。
- 受領データのデータ検証を早急に行ったことで、手戻りを減らすことに貢献できた。
- お客様と合意したドキュメントを作成したことで、正しいとする基準を設けることができた。
- ドキュメントを作成したことで、属人化を防いだだけでなく、埋もれていた各メンバーの知識を表面化できた。

## 1.6. 実施内容2：プロジェクト全体のデータ連携処理の整理

本プロジェクトにおける全データ連携処理を洗い出し、データ連携処理同士の依存関係可視化を行った。
その後、データ構造を一部変更し、データ連携処理フローの最適化を図った。

### 1.6.1. 背景・課題・問題点

- 先行・後続する処理の担当者間で入力データ・出力データについて認識のずれがあった。
- 運用開始時の連携処理実行手順が曖昧だった。

### 1.6.2. 取り組み

以下のように実施した。

1. 各データストアおよび各データ連携処理の依存関係をスイムレーン図により可視化
2. 既にNeo4jにデータがある場合やドメインの観点からNeo4jにあるべきデータは、データ格納先をNeo4jに変更
3. 連携処理担当者全員で打ち合わせを行い、修正が必要であれば修正
4. 1.〜3.を繰り返し

### 1.6.3. 結果

- 担当者全員が共通認識を持つことができただけでなく、依存関係をシンプルにすることができた。
- プロジェクト全体での連携処理におけるエントリポイントが明確になり、自動化への足がかりになった。

## 1.7. 実施内容3：Neo4jデータ管理

Neo4jにおけるデータ設計書を作成後、制約およびインデックスの管理を行った。

### 1.7.1. 背景・課題・問題点

- Neo4jデータ設計が途中で終わっていた。
- マスタデータなどのメタデータのデータ更新が容易にできるデータ構造になっていなかった。
- 既に開発が進んでおり、データ構造の変更が一部できなかった。
- 制約・インデックスの管理がされていなかった。

### 1.7.2. 取り組み

Neo4jデータ管理については、以下のように実施した。

1. 既存のデータ設計をドキュメント化
2. 既存のデータ設計の問題点を洗い出し
3. 制約・インデックス含め、データ設計の変更案検討
4. メンバーと打ち合わせ、データ設計変更
5. 3.~4.を繰り返し
6. 制約・インデックス登録クエリ作成、テスト実装、テスト自動化
7. 開発環境Neo4jを利用してパフォーマンス等検証

データ構造の変更ができない点に関しては、グラフDBの特性を活かして対応した。
具体的には、既存のデータ構造に加えて、データ更新用のリレーションやプロパティを別途作成した。

### 1.7.3. 結果

- Neo4jの制約・インデックスがコード管理できるようになった。
- メタデータのデータ更新が容易になった。
- データ連携処理のパフォーマンスが向上した。
- ドキュメントを作成したことで、正しいとする基準を設けることができた。
- ドキュメントを作成したことで、属人化を防いだだけでなく、埋もれていた各メンバーの知識を表面化できた。

## 1.8. 実施内容4：Neo4jへのデータ登録機能およびNeo4jからのデータ出力機能の再実装

既存実装はプロダクションレディな状態ではなく、仕様変更に耐えられる構造になっていなかったため、Neo4jへのデータ登録機能およびNeo4jからのデータ出力機能を再実装した。
トランザクション化やタイムアウト・リトライ機能、ロギング、CI/CDパイプラインも実装した。

### 1.8.1. 背景・課題・問題点／取り組み／結果

| 背景・課題・問題点                                                                      | 取り組み                                                                                                  | 結果                                                                               |
| :-------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------- |
| 既存実装に関するドキュメントがなかった。                                                | 既存実装のコード、特にテストコードを熟読。仕様に関わる内容は抽出してドキュメント化。                      | 仕様の概要が把握できた。コードに埋もれていた知識を表面化できた。                   |
| 既存実装では、コード同士が密に結合していたため、テストが容易でなかった。                | レイヤを分けて実装した。                                                                                  | 単体テストの実装が容易になった。                                                   |
| 既存実装では、コード同士が密に結合していたため、仕様変更に耐えられなかった。            | レイヤを分けて実装した。                                                                                  | 既存コードへの影響を最小限にして仕様修正や新機能追加ができるようになった。         |
| 既存実装では、トランザクションについて考慮されていなかった。                            | Neo4jドライバの関数をラップしてトランザクション化するための共通関数を作成した。                           | トランザクション化が容易になり、より安定した機能の実装ができた。                   |
| 既存実装では、タイムアウトやリトライについて考慮されていなかった。                      | Neo4jドライバの関数をラップしてタイムアウト処理やリトライ処理（指数関数バックオフ）の共通関数を作成した。 | タイムアウト処理やリトライ処理の実装が容易になり、より安定した機能の実装ができた。 |
| 既存実装では、単体テストとしてチームメンバー全員が使用するNeo4jのデータを使用していた。 | テストスタブとしてのNeo4jコンテナを作成した。                                                             | Neo4jを使用するテストが容易になった。                                              |
| スケジュールが逼迫していた。                                                            | システム稼働までに手動実行できる状態まで作成、処理の自動化は保守・運用内の工数で対応した。                | 保守・運用の工数内でDataflowでの自動化を行った。                                   |

---

## 1.9. その他アピールポイント

### 1.9.1. キャッチアップ力

本プロジェクトにアサイン当初、グラフDBやNeo4jは未経験だったため、以下を実施した。

- Neo4j公式のドキュメント閲読
- Neo4j GraphAcademyのハンズオントレーニング実施

また、実装時にエラーや課題に直面したときは、公式のGitHub IssueやFAQを確認した。
結果、Neo4jクエリの実装ができるだけでなく、メンバーのコードレビューや制約・インデックスの付与などもできるようになった。

### 1.9.2. 行動力

当初、本プロジェクトには「既存機能の改修」を行う、プログラマの立場でアサインされた。
しかし、プロジェクト管理として多くの課題があったため、自らメンバーと打ち合わせを行ったり、ドキュメント作成やデータ構造の見直しなども実施した。
結果、プロジェクト全体を通して品質を向上させることに貢献することができた。

---

## 1.10. 開発言語・使用技術

メイン言語はPython。
一部、開発補助スクリプト作成のためにMakefileやShell Scriptを使用。

量が多いため、前述した実施内容関連のみ記載。

| カテゴリ                   | 使用技術               | 使用目的                                                                                        |
| -------------------------- | ---------------------- | ----------------------------------------------------------------------------------------------- |
| Google Cloud               | BigQuery               | ビッグデータ解析用データウェアハウス                                                            |
| Google Cloud               | Cloud Firestore        | Neo4jからElasticsearchに登録されるジョブ情報の保持                                              |
| Google Cloud               | Cloud Functions        | 軽量なデータ連携処理の実行                                                                      |
| Google Cloud               | Cloud Logging          | データ連携処理のログ管理                                                                        |
| Google Cloud               | Cloud Monitoring       | データ連携処理のエラーやワーニングの通知                                                        |
| Google Cloud               | Cloud Pub/Sub          | Neo4jデータ更新に関するイベントの送受信                                                         |
| Google Cloud               | Cloud Scheduler        | 日次や月次など定期的に実行が必要なデータ連携処理パイプラインの起動                              |
| Google Cloud               | Cloud Storage          | 受領データファイルや中間データファイルの保持                                                    |
| Google Cloud               | Dataflow               | リソースを多く使用するデータ連携処理パイプラインの実行                                          |
| Google Cloud               | Secret Manager         | Neo4jのユーザ・パスワードなど、機密情報の保持・管理                                             |
| その他マネージドサービス   | Elastic Cloud          | 類似画像検索で使用する商品データの保持                                                          |
| その他マネージドサービス   | Neo4j Aura             | 顧客情報、購買情報などの購買行動に関するデータの保持                                            |
| コンテナ技術               | Docker, Docker Compose | 開発用・テスト用Neo4jコンテナやAPIコンテナを作成                                                |
| CI/CD                      | GitHub Actions         | CI（フォーマットチェック、リント、テストの自動化）、CD(Cloud Functionsなどへのデプロイ自動化）  |
| ライブラリ・フレームワーク | google-cloud-xxx       | BigQueryやCloud Storageなど、Google Cloudサービスの利用                                         |
| ライブラリ・フレームワーク | loguru                 | CLI、Cloud Functions、Dataflowなどインターフェースの違いによるログ出力形式の切り替え            |
| ライブラリ・フレームワーク | neo4j-python-driver    | Neo4jドライバ                                                                                   |
| ライブラリ・フレームワーク | pandas                 | ファイル読込時のデータチェック、重複除去、デフォルト値補完、データ変換など                      |
| ライブラリ・フレームワーク | pydantic               | Neo4jにおけるノードやエッジ、リレーションなどのデータ構造をモデル化・インスタンス化、コンフィグ |
| ライブラリ・フレームワーク | requests               | 外部APIへのリクエスト                                                                           |
| ライブラリ・フレームワーク | typer                  | CLI実装                                                                                         |
| ライブラリ・フレームワーク | black, isort           | Pythonコードのフォーマット                                                                      |
| ライブラリ・フレームワーク | mypy, pylint           | Pythonコードのリント                                                                            |
| ライブラリ・フレームワーク | pytest                 | Pythonコードのテスト全般                                                                        |
| ライブラリ・フレームワーク | pytest-docker          | テスト時に使用するNeo4jコンテナやAPIコンテナの自動起動                                          |
| その他ツール               | arrows.app             | Neo4jのデータモデリング                                                                         |
| その他ツール               | draw.io                | フローチャートやスイムレーン図などの作図                                                        |
| その他ツール               | Slack                  | チームメンバーとの情報共有                                                                      |
